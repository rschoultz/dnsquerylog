<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Refresh" content="3600">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .lg-pill {
            border-radius: 20px !important;
            margin-top: 1rem;
            font-size: 1rem;
        }

        .bi::before {
            display: inline-block;
            content: "";
            vertical-align: -.125em;
            background-image: url("data:image/svg+xml,<svg viewBox='0 0 16 16' fill='%23333' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' d='M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z' clip-rule='evenodd'/></svg>");
            background-repeat: no-repeat;
            background-size: 1rem 1rem;
        }
    </style>
    <title>DNS Query Vulnerability Tester</title>
</head>
<body>
<div class="container">
    <h1>DNS Query Vulnerability Tester</h1>

    <p>
        While investigating software that is affected by CVE-2021-44228, it is necessary to test whether services
        can be provoked to look up a name using DNS, potentially exposing information from the internal
        infrastructure.
        Use this tool to detect vulnerable Log4j versions or any other software that attempts
        to either signal to a third party that there may be vulnerable systems, or even to
        exfiltrate information via name lookups.
    </p>

    <div class="alert alert-info" role="alert">
        Using addresses produced by this tool will make it possible to detect whether your servers are trying to look up
        the
        name. The addresses that you create are unique, and information about attempts of using the address
        is only shared with this page, while you have this window open.
    </div>

    <div>
        Usage:
        <ol>
            <li>Copy one of the generated strings, and paste it into an application you would like to test.</li>
            <li>If you see output in the table, it means there is high likelihood of vulnerabilities.</li>
            <li>Additional information, retrieved from your service. This is only possible if you modify the generated
                address further, though.
            </li>
        </ol>
    </div>
    <div class="alert alert-warning" role="alert">
        <b>Conditional use</b>. You may only use this tool with systems which you have explicit permission to test.
    </div>
    <div>
        Notes:
        <ul>
            <li><strong>Press Get address often</strong>. Once an address has been used, it is likely cached by some
                resolver. Hence use a new for next test.
            </li>
            <li><strong>You can only use one address at a time</strong>. When you request a new address, the previous
                are no longer
                usable.
            </li>
        </ul>
    </div>

    <div id="dnsqueryapp" class="container">
        <div class="row">
            <div class="col-3">

                <div class="row">
                    <form>
                        <button id="open" class="btn btn-outline-primary">Get address</button>
                        <button id="close" class="btn btn-outline-secondary">Close</button>
                    </form>
                </div>
                <div class="row">
                    <div v-if="listenActive">
                        <span class="badge rounded-pill lg-pill bg-success"> Listening </span>
                    </div>
                    <div v-else>
                        <span class="badge rounded-pill lg-pill bg-danger"> Inactive </span>
                    </div>
                </div>
            </div>
            <div class="col-7">
                <div class="input-group mb-3">
                    <button class="btn btn-outline-info btn-sm" @click="copyUrl(address)">Copy
                    </button>
                    <transition v-if="depletedUrl"  name="fade" :duration="1000">
                        <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" class="btn btn-secondary" title="A DNS lookup has been seen using this address,
and any additional use will likely not work as
resolvers caches this information.">
                            Depleted
                        </button>
                    </transition>
                    <input type="text" v-model="address" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <button class="btn btn-outline-info btn-sm" id="button-vuln1" @click="copyUrl(vuln1)">Copy
                    </button>
                    <transition v-if="depletedUrl"  name="fade" :duration="1000">
                        <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" class="btn btn-secondary" title="A DNS lookup has been seen using this address,
and any additional use will likely not work as
resolvers caches this information.">
                            Depleted
                        </button>
                    </transition>
                    <input type="text" v-model="vuln1" class="form-control" aria-describedby="button-vuln1"></input>
                </div>
            </div>

        </div>
        <div class="row">
            <div class="">
                <h2>Detected name lookups</h2>
            </div>
            <div id="output"></div>
            <div id="table">
                <table class="table">
                    <thead>
                    <tr scope="row">
                        <th scope="col">Time</th>
                        <th scope="col">Address</th>
                        <th scope="col">Additional</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="item in rowData">
                        <td>${item.time}</td>
                        <td>${item.url}
                            <span class="badge sm-pill rounded-pill bg-warning">${item.protocol} ${item.querytype}</span>
                        </td>
                        <td>${item.exfiltrated}
                            <span v-if="item.exfiltrated" class="badge sm-pill rounded-pill bg-danger">
                                <i class="bi-exclamation-triangle" style="font-size: 1rem; color: white;"></i>
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/vue@3.1.1/dist/vue.global.prod.js"></script>
<script>

    const DnsQueryApp = {
        delimiters: ['${', '}'],
        data: function () {
            return {
                address: '',
                vuln1: '',
                listenActive: false,
                rowData: [],
                depletedUrl: false,
            }
        },
        methods: {
            setAddress(url) {
                this.address = url;
                this.depletedUrl = false;

                //this.vuln1 = "${jndi:ldap:" + this.address + "/a}";
                this.vuln1 = "${jndi:dns://" + this.address + "/a}";
            },
            copyUrl(data) {
                try {
                    navigator.clipboard.writeText(data);
                } catch ($e) {
                    alert('Cannot copy');
                }
            },
            lookup(message) {
                let new_row = {
                    time: message.Time,
                    url: message.Url,
                    exfiltrated: message.Exfiltrated,
                    querytype: message.Query,
                    protocol: message.Protocol,
                };
                this.rowData.push(new_row)
                this.depletedUrl = this.depletedUrl || message.DepletedUrl

            }
        }
    }

    const vm = Vue.createApp(DnsQueryApp).mount('#dnsqueryapp')

    window.addEventListener("load", function (evt) {
        var output = document.getElementById("output");
        var ws;
        var intervalCheckId;
        var intervalFailures = 0;

        var closeWs = function (ws) {
            clearInterval(intervalCheckId);
            vm.listenActive = false;
            if (!ws) {
                return false;
            }
            ws.close();
        };

        document.getElementById("open").onclick = function (evt) {
            closeWs(ws);
            ws = new WebSocket("{{.}}");

            ws.onclose = function (evt) {
                vm.setAddress("")
                vm.listenActive = false;
            }

            ws.onopen = function () {
                clearInterval(intervalCheckId);
                intervalCheckId = window.setInterval(function () {
                    if (!ws) {
                        vm.listenActive = false;
                        clearInterval(intervalCheckId);
                        // console.log("no - not open for" + vm.address)
                        return false;
                    } else {
                        vm.listenActive = true;
                    }

                    // console.log("Are we active? " + vm.address)
                    if (ws.readyState === 1) {
                        ws.send(vm.address);
                        vm.listenActive = true;
                        // console.log("Yes")
                    } else {
                        vm.listenActive = false;
                        clearInterval(intervalCheckId)
                        // console.log("No")
                    }
                }, 1000);
            }

            ws.onmessage = function (evt) {
                let msg = JSON.parse(evt.data);
                switch (msg.Type) {
                    case 'newaddress':
                        // console.log("New address: " + msg.Url);
                        vm.setAddress(msg.Url);

                        break;
                    case 'lookup':
                        vm.lookup(msg);
                        break;
                }
            }
            ws.onerror = function (evt) {
                // console.log("Got error - trying to shut down things.")
                clearInterval(intervalCheckId)
                vm.listenActive = false;
            }
            return false;
        };
        document.getElementById("close").onclick = function (evt) {
            closeWs(ws)
            return false;
        };
    });
</script>

</html>